/* eslint-env node */
/* eslint-disable no-console */

import { resolve } from "node:path";
import { createOpenAPI } from "fumadocs-openapi/server";
import { generateFiles } from "fumadocs-openapi";

const projectRoot = resolve(import.meta.dirname, "..");
const openApiPath = resolve(projectRoot, "../../docs/protocol/openapi.yaml");
const outputDir = resolve(projectRoot, "content/protocol/api");

const openApiServer = createOpenAPI({
  input: [openApiPath],
});

await generateFiles({
  input: openApiServer,
  output: outputDir,
  per: "operation",
  beforeWrite(files) {
    for (const file of files) {
      if (!file.path.endsWith(".mdx")) {
        continue;
      }

      if (file.content.includes('import { APIPage } from "@/lib/openapi-page";')) {
        continue;
      }

      const generatedCommentPattern = /\{\/\* This file was generated by Fumadocs\.[\s\S]*?\*\/\}/m;
      const importStatement = 'import { APIPage } from "@/lib/openapi-page";';

      if (generatedCommentPattern.test(file.content)) {
        file.content = file.content.replace(
          generatedCommentPattern,
          (match) => `${match}\n\n${importStatement}`,
        );
        continue;
      }

      const frontmatterEnd = file.content.indexOf("\n---\n", 4);
      if (frontmatterEnd !== -1) {
        const insertAt = frontmatterEnd + "\n---\n".length;
        file.content = `${file.content.slice(0, insertAt)}\n${importStatement}\n${file.content.slice(insertAt)}`;
      } else {
        file.content = `${importStatement}\n\n${file.content}`;
      }
    }
  },
});

console.log("âœ… API docs generated at content/protocol/api/");
